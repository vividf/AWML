import gc
import psutil
import os
from autoware_ml.calibration_classification.datasets.transforms.calibration_classification_transform import CalibrationClassificationTransform

# 準備一個 sample dict，根據你的資料格式
results = {
  'frame_idx': '00000',
 'images': {'CAM_BACK': {'cam2ego': [[0.0030803714045190556,
                                      0.808535809509991,
                                      -0.5884389144609949,
                                      -1.3274172015677728],
                                     [0.9999951683191377,
                                      -0.0027365201681254225,
                                      0.0014747188713151171,
                                      -0.14793543135002984],
                                     [-0.0004179119407138887,
                                      -0.5884406139937941,
                                      -0.8085403324214672,
                                      2.717673379610521],
                                     [0.0, 0.0, 0.0, 1.0]],
                         'cam2img': [[1116.65283, 0.0, 1399.73962],
                                     [0.0, 1283.91125, 935.9842],
                                     [0.0, 0.0, 1.0]],
                         'cam_pose': [[-0.08941801662585887,
                                       0.9956581019527168,
                                       0.0258720373880999,
                                       94538.65930215122],
                                      [-0.99595822865445,
                                       -0.08916389272508166,
                                       -0.010816977840441121,
                                       42958.04725601462],
                                      [-0.008463160059226362,
                                       -0.02673470123311179,
                                       0.999606738008397,
                                       42.44716498971519],
                                      [0.0, 0.0, 0.0, 1.0]],
                         'height': 1860,
                         'img_path': '/workspace/data/t4dataset/db_j6gen2_v3/104113be-6d9f-40dc-bbbf-1be9f772ccac/0/data/CAM_BACK/00000.jpg',
                         'lidar2cam': [[0.003148340258576391,
                                        0.9999949129620398,
                                        -0.0005118629294341565,
                                        0.1535594651795691],
                                       [0.8084573572941398,
                                        -0.002846569164158503,
                                        -0.5885478727180729,
                                        2.7308965164629626],
                                       [-0.5885463358059342,
                                        0.0014391296105506352,
                                        -0.808462206609173,
                                        1.372812407611491],
                                       [0.0, 0.0, 0.0, 1.0]],
                         'sample_data_token': 'fa7991ffa5ef38edcde8c2874f0e3c96',
                         'timestamp': 1749704568040913,
                         'width': 2880},
            'CAM_BACK_LEFT': {'cam2ego': [[0.765711210400916,
                                           0.06583529982219027,
                                           -0.6398062640860014,
                                           4.560758909471524],
                                          [0.6430753039883366,
                                           -0.0966955711770146,
                                           0.759673693051865,
                                           1.0090992804951078],
                                          [-0.011853086799327672,
                                           -0.993134270787225,
                                           -0.11637793829267812,
                                           2.72998306821654],
                                          [0.0, 0.0, 0.0, 1.0]],
                              'cam2img': [[883.50861, 0.0, 1407.75302],
                                          [0.0, 1259.72729, 944.15259],
                                          [0.0, 0.0, 1.0]],
                              'cam_pose': [[-0.08920715189504932,
                                            0.9956833056802377,
                                            0.0256288673266761,
                                            94538.64034165577],
                                           [-0.9959802401416264,
                                            -0.08896567676954127,
                                            -0.010414874188666847,
                                            42957.82964936758],
                                           [-0.008089826833861061,
                                            -0.026454926698296976,
                                            0.9996172725374377,
                                            42.447210336561156],
                                           [0.0, 0.0, 0.0, 1.0]],
                              'height': 1860,
                              'img_path': '/workspace/data/t4dataset/db_j6gen2_v3/104113be-6d9f-40dc-bbbf-1be9f772ccac/0/data/CAM_BACK_LEFT/00000.jpg',
                              'lidar2cam': [[0.7656279388236062,
                                             0.6431800273904781,
                                             -0.011546066806547454,
                                             -4.220130966899887],
                                            [0.06609241621965066,
                                             -0.09650332895316793,
                                             -0.9931358920204253,
                                             2.5002115961506206],
                                            [-0.6398794041153113,
                                             0.7596094785262629,
                                             -0.11639496691048815,
                                             2.561892677011201],
                                            [0.0, 0.0, 0.0, 1.0]],
                              'sample_data_token': '41432d92a15c58b1e9e19525a9227943',
                              'timestamp': 1749704568060727,
                              'width': 2880},
            'CAM_BACK_RIGHT': {'cam2ego': [[-0.7688431511775673,
                                            0.055363787644784335,
                                            -0.6370361527456441,
                                            4.546697264867554],
                                           [0.6394364445253757,
                                            0.06830442322458465,
                                            -0.7658038516361111,
                                            -0.9722004436503047],
                                           [0.0011145851669600582,
                                            -0.9961271790216247,
                                            -0.0879170115183947,
                                            2.7477550958821135],
                                           [0.0, 0.0, 0.0, 1.0]],
                               'cam2img': [[881.66516, 0.0, 1407.78016],
                                           [0.0, 1257.4342, 942.12822],
                                           [0.0, 0.0, 1.0]],
                               'cam_pose': [[-0.08852630608767245,
                                             0.9957660998528574,
                                             0.024758180755065314,
                                             94538.57609223339],
                                            [-0.9960386338527908,
                                             -0.0882868515366326,
                                             -0.010605268427272961,
                                             42957.08766184823],
                                            [-0.008374544951078677,
                                             -0.025598949774890415,
                                             0.9996372145770107,
                                             42.440624785554476],
                                            [0.0, 0.0, 0.0, 1.0]],
                               'height': 1860,
                               'img_path': '/workspace/data/t4dataset/db_j6gen2_v3/104113be-6d9f-40dc-bbbf-1be9f772ccac/0/data/CAM_BACK_RIGHT/00000.jpg',
                               'lidar2cam': [[-0.7693701390189868,
                                              0.6388007332304367,
                                              0.0017923197711856038,
                                              4.7972957706369925],
                                             [0.05528612762773503,
                                              0.06938117973470714,
                                              -0.9960570746651776,
                                              2.5033138398646315],
                                             [-0.6364063428956658,
                                              -0.7662374795863731,
                                              -0.08869662676386156,
                                              2.961949165997794],
                                             [0.0, 0.0, 0.0, 1.0]],
                               'sample_data_token': '101ddb53e7a458dd919d31d1ef297ac8',
                               'timestamp': 1749704568128114,
                               'width': 2880},
            'CAM_FRONT': {'cam2ego': [[0.006751065445899984,
                                       -0.006644674898190983,
                                       0.9999551346989739,
                                       5.314823352615826],
                                      [-0.9999771102392598,
                                       0.00040471033338729256,
                                       0.006753903100116143,
                                       0.05013098725079912],
                                      [-0.0004495696663305848,
                                       -0.9999778420070335,
                                       -0.006641790577225082,
                                       2.8033999279803035],
                                      [0.0, 0.0, 0.0, 1.0]],
                          'cam2img': [[878.86743, 0.0, 1402.0576],
                                      [0.0, 1255.89441, 945.04759],
                                      [0.0, 0.0, 1.0]],
                          'cam_pose': [[-0.08892765430455203,
                                        0.9957189918915034,
                                        0.02521034483022576,
                                        94538.61005861571],
                                       [-0.9960040185093805,
                                        -0.08868678164185302,
                                        -0.0105190244403595,
                                        42957.48131541199],
                                       [-0.008238168064362795,
                                        -0.026045036927965455,
                                        0.9996268246892761,
                                        42.444423002164214],
                                       [0.0, 0.0, 0.0, 1.0]],
                          'height': 1860,
                          'img_path': '/workspace/data/t4dataset//db_j6gen2_v3/104113be-6d9f-40dc-bbbf-1be9f772ccac/0/data/CAM_FRONT/00000.jpg',
                          'lidar2cam': [[0.00716945048421609,
                                         -0.9999737571205187,
                                         -0.001041177231576467,
                                         0.013260173218441196],
                                        [-0.006540037873994502,
                                         0.000994292065383099,
                                         -0.9999781194045672,
                                         2.843243887990411],
                                        [0.999952912333556,
                                         0.007176102950898632,
                                         -0.006532737716839118,
                                         -5.791093642525084],
                                        [0.0, 0.0, 0.0, 1.0]],
                          'sample_data_token': '66edd5d825691448d7bc6b9b0f451c1e',
                          'timestamp': 1749704568092388,
                          'width': 2880},
            'CAM_FRONT_LEFT': {'cam2ego': [[0.7595208374986263,
                                            -0.05311785423418097,
                                            0.6483105667555799,
                                            4.758573501497678],
                                           [-0.6492291771257197,
                                            -0.12375344387561743,
                                            0.7504575675530131,
                                            0.9947554833701981],
                                           [0.040367969654737434,
                                            -0.9908902959916807,
                                            -0.1284789801308895,
                                            2.726112072147638],
                                           [0.0, 0.0, 0.0, 1.0]],
                               'cam2img': [[876.26178, 0.0, 1407.91023],
                                           [0.0, 1254.09937, 950.67237],
                                           [0.0, 0.0, 1.0]],
                               'cam_pose': [[-0.08912032881818933,
                                             0.9956955553564046,
                                             0.025454430554203114,
                                             94538.62901174628],
                                            [-0.9959853749183372,
                                             -0.08887230383163315,
                                             -0.010716648750315003,
                                             42957.699380536724],
                                            [-0.00840832564293007,
                                             -0.02630731181931787,
                                             0.9996185399464758,
                                             42.44499727595134],
                                            [0.0, 0.0, 0.0, 1.0]],
                               'height': 1860,
                               'img_path': '/workspace/data/t4dataset/db_j6gen2_v3/104113be-6d9f-40dc-bbbf-1be9f772ccac/0/data/CAM_FRONT_LEFT/00000.jpg',
                               'lidar2cam': [[0.7596725177867087,
                                              -0.6490683349759908,
                                              0.040099404622747865,
                                              -3.2876096560939914],
                                             [-0.053159116158086106,
                                              -0.12343711688838266,
                                              -0.9909275384928887,
                                              3.092015168764192],
                                             [0.6481294423870088,
                                              0.7506487692028673,
                                              -0.12827568438845405,
                                              -3.6606738917544135],
                                             [0.0, 0.0, 0.0, 1.0]],
                               'sample_data_token': '997b49957699b17acf2ef272e867cc14',
                               'timestamp': 1749704568072579,
                               'width': 2880},
            'CAM_FRONT_RIGHT': {'cam2ego': [[-0.7561176730459567,
                                             -0.040637880640399304,
                                             0.6531727391468695,
                                             4.761802719317536],
                                            [-0.6537317267016107,
                                             0.0931820219519435,
                                             -0.7509673363660221,
                                             -0.979306810434095],
                                            [-0.0303462355375137,
                                             -0.9948194175035006,
                                             -0.09702284548856296,
                                             2.7419517593417337],
                                            [0.0, 0.0, 0.0, 1.0]],
                                'cam2img': [[876.48627, 0.0, 1399.22928],
                                            [0.0, 1252.60815, 939.52854],
                                            [0.0, 0.0, 1.0]],
                                'cam_pose': [[-0.08873210656298942,
                                              0.9957415234844863,
                                              0.02500863198354298,
                                              94538.59396712665],
                                             [-0.9960216668693059,
                                              -0.08849409417955821,
                                              -0.010470645740758094,
                                              42957.29588449116],
                                             [-0.008212940507715252,
                                              -0.02583822176802178,
                                              0.999632399386936,
                                              42.44320827023975],
                                             [0.0, 0.0, 0.0, 1.0]],
                                'height': 1860,
                                'img_path': '/workspace/data/t4dataset/db_j6gen2_v3/104113be-6d9f-40dc-bbbf-1be9f772ccac/0/data/CAM_FRONT_RIGHT/00000.jpg',
                                'lidar2cam': [[-0.7557120386973568,
                                               -0.6541713597535198,
                                               -0.030970092768940367,
                                               3.5593341672138195],
                                              [-0.04056076971619317,
                                               0.0939505672901537,
                                               -0.9947502776405188,
                                               3.0416756592439924],
                                              [0.6536467995239599,
                                               -0.7504885895095872,
                                               -0.0975332686215067,
                                               -4.023230747421621],
                                              [0.0, 0.0, 0.0, 1.0]],
                                'sample_data_token': 'a3f960c51a3a7ae86972d99994382ac7',
                                'timestamp': 1749704568109220,
                                'width': 2880}},
 'lidar_points': {'lidar2ego': [[1.0, 0.0, 0.0, 0.0],
                                [0.0, 1.0, 0.0, 0.0],
                                [0.0, 0.0, 1.0, 0.0],
                                [0.0, 0.0, 0.0, 1.0]],
                  'lidar_path': '/workspace/data/t4dataset/db_j6gen2_v3/104113be-6d9f-40dc-bbbf-1be9f772ccac/0/data/LIDAR_CONCAT/00000.pcd.bin',
                  'lidar_pose': [[-0.08934684545290333,
                                  0.9956665989306409,
                                  0.025790792572267116,
                                  94538.65294183002],
                                 [-0.9959657214540635,
                                  -0.08909714162669084,
                                  -0.010676190446073087,
                                  42957.97426218123],
                                 [-0.0083320403325015,
                                  -0.026640629268921166,
                                  0.9996103510748846,
                                  42.447204569052765],
                                 [0.0, 0.0, 0.0, 1.0]],
                  'sample_data_token': '4eef0531f88ba3c2c736c665cb0ef80f',
                  'timestamp': 1749704568047560},
 'sample_idx': 0,
 'scene_id': '104113be-6d9f-40dc-bbbf-1be9f772ccac'
 }

tf = CalibrationClassificationTransform(debug=False, enable_augmentation=False)

def print_mem():
    process = psutil.Process(os.getpid())
    print(f"Memory usage: {process.memory_info().rss / 1024**2:.2f} MB")

for i in range(1000):
    results["sample_idx"] = i
    out = tf.transform(results.copy())
    del out
    gc.collect()
    if i % 10 == 0:
        print_mem()